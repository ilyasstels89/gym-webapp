<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Fitness</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --card: #1c1c1e; --blue: #007aff; --text: #fff; --gray: #8e8e93; --green: #32d74b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 100px; user-select: none; margin:0; }
        
        h1 { font-size: 20px; margin: 0 0 5px 0; }
        .info-row { display: flex; justify-content: space-between; align-items: center; color: var(--gray); font-size: 14px; margin-bottom: 20px; }
        
        .ex-card { background: var(--card); border-radius: 14px; padding: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .ex-head { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .ex-name { font-weight: bold; font-size: 16px; width: 75%; }
        .ex-rest { font-size: 11px; background: #333; padding: 2px 6px; border-radius: 4px; height: fit-content; display: flex; align-items: center;}

        /* –ó–ê–ì–û–õ–û–í–ö–ò –°–¢–û–õ–ë–¶–û–í */
        .col-headers { display: flex; margin-bottom: 5px; font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px;}
        .col-spacer { width: 25px; } /* –ú–µ—Å—Ç–æ –ø–æ–¥ –Ω–æ–º–µ—Ä */
        .col-w { flex: 1; text-align: center; }
        .col-r { flex: 1; text-align: center; }
        .col-check { width: 36px; }

        .set-row { display: flex; align-items: center; margin-bottom: 8px; background: #0b0b0b; padding: 6px; border-radius: 8px; }
        .set-n { color: #555; width: 25px; font-size: 12px; text-align: center;}
        
        input { 
            width: 100%; background: #1c1c1e; border: 1px solid #333; 
            color: #fff; padding: 10px; border-radius: 6px; text-align: center; margin: 0 5px; font-size: 16px; 
            font-weight: bold;
        }
        input:focus { border-color: var(--blue); outline: none; }
        input:disabled { opacity: 0.4; background: #111; border-color: #222; }
        
        .check { width: 36px; height: 36px; background: #222; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #333; font-size: 18px; color: #444; }
        .check.done { background: var(--green); border-color: var(--green); color: #000; }

        .btn-finish { width: 100%; padding: 16px; background: #ff3b30; color: #fff; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 20px; }

        /* MODAL */
        #rest-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
        .timer-big { font-size: 90px; font-weight: bold; font-variant-numeric: tabular-nums; margin-bottom: 30px;}
        .btn-skip { background: #333; color: #fff; padding: 15px 40px; border-radius: 30px; border: 1px solid #444; font-size: 16px; }
    </style>
</head>
<body>

    <h1 id="t">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
    <div class="info-row">
        <span id="d">...</span>
        <span id="gt" style="font-family: monospace; background:#222; padding:4px 8px; border-radius:6px;">00:00</span>
    </div>

    <div id="list"></div>

    <div style="text-align: center; margin-top: 40px;">
        <p style="color:#666; font-size:12px; margin-bottom: 10px;">–°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (1-10)</p>
        <input type="range" id="rpe" min="1" max="10" value="7" style="accent-color: var(--blue); margin-bottom: 20px;">
        <button class="btn-finish" onclick="fin()">üèÅ –ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>

    <!-- REST -->
    <div id="rest-modal">
        <div style="color: #888; font-size: 18px;">–û—Ç–¥—ã—Ö</div>
        <div class="timer-big" id="rt">00:00</div>
        <button class="btn-skip" onclick="stopRest()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp; 
        tg.expand();
        
        let w = { t: "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö", d: "", e: [] };
        let start = Date.now();
        let rInt;
        const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

        // 1. –†–ê–°–ü–ê–ö–û–í–ö–ê
        const p = new URLSearchParams(location.search);
        const raw = p.get('data');
        if(raw) {
            try { w = JSON.parse(decodeURIComponent(raw)); } catch(e){ console.error(e); }
        }

        // 2. –û–¢–†–ò–°–û–í–ö–ê
        document.getElementById('t').innerText = w.t || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
        document.getElementById('d').innerText = "‚è± " + (w.d || "? –º–∏–Ω");

        const list = document.getElementById('list');
        
        (w.e || []).forEach((ex, i) => {
            let setsHtml = '';
            const count = ex.s || 3;
            
            for(let j=0; j<count; j++) {
                setsHtml += `
                <div class="set-row">
                    <div class="set-n">${j+1}</div>
                    <input type="tel" id="w-${i}-${j}" value="${ex.w || ''}" placeholder="-">
                    <input type="tel" id="r-${i}-${j}" value="${ex.r || ''}" placeholder="-">
                    <div class="check" id="btn-${i}-${j}" onclick="toggle(${i},${j},${ex.rt||0})">‚úì</div>
                </div>`;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ –≤–Ω—É—Ç—Ä—å –∫–∞—Ä—Ç–æ—á–∫–∏
            list.innerHTML += `
            <div class="ex-card">
                <div class="ex-head">
                    <div class="ex-name">${ex.n}</div>
                    <div class="ex-rest">üïê ${ex.rt > 0 ? ex.rt + '—Å' : '–ù–µ—Ç'}</div>
                </div>
                
                <div class="col-headers">
                    <div class="col-spacer"></div>
                    <div class="col-w">–í–µ—Å (–∫–≥)</div>
                    <div class="col-r">–ü–æ–≤—Ç–æ—Ä—ã</div>
                    <div class="col-check"></div>
                </div>

                ${setsHtml}
            </div>`;
        });

        // 3. –õ–û–ì–ò–ö–ê –ö–õ–ò–ö–ê
        function toggle(i, j, rest) {
            const b = document.getElementById(`btn-${i}-${j}`);
            const inpW = document.getElementById(`w-${i}-${j}`);
            const inpR = document.getElementById(`r-${i}-${j}`);
            
            if(b.classList.contains('done')) {
                // –û—Ç–º–µ–Ω–∞
                b.classList.remove('done');
                inpW.disabled = false; inpR.disabled = false;
            } else {
                // –°–¥–µ–ª–∞–Ω–æ
                b.classList.add('done');
                inpW.disabled = true; inpR.disabled = true;
                tg.HapticFeedback.notificationOccurred('success');
                
                // –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–ê (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–¥—ã—Ö > 0)
                if(rest > 0) {
                    runRest(rest);
                }
            }
        }

        // 4. –¢–ê–ô–ú–ï–†
        function runRest(sec) {
            document.getElementById('rest-modal').style.display = 'flex';
            let t = sec;
            document.getElementById('rt').innerText = fmt(t);
            
            if(rInt) clearInterval(rInt);
            
            rInt = setInterval(() => {
                t--;
                document.getElementById('rt').innerText = fmt(t);
                if(t<=0) {
                    clearInterval(rInt);
                    beep.play();
                    tg.HapticFeedback.notificationOccurred('warning');
                    setTimeout(stopRest, 1000);
                }
            }, 1000);
        }

        function stopRest() {
            clearInterval(rInt);
            document.getElementById('rest-modal').style.display = 'none';
        }

        function fmt(s) {
            return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0');
        }

        // –û–±—â–µ–µ –≤—Ä–µ–º—è
        setInterval(() => {
            document.getElementById('gt').innerText = fmt(Math.floor((Date.now()-start)/1000));
        }, 1000);

        // 5. –ó–ê–í–ï–†–®–ï–ù–ò–ï
        function fin() {
            try {
                const res = [];
                (w.e || []).forEach((ex, i) => {
                    const count = ex.s || 3;
                    let done = 0; let lastW = ex.w;
                    for(let j=0; j<count; j++) {
                        if(document.getElementById(`btn-${i}-${j}`).classList.contains('done')) {
                            done++;
                            lastW = document.getElementById(`w-${i}-${j}`).value;
                        }
                    }
                    if(done > 0) res.push({ name: ex.n, weight: lastW, reps: ex.r, sets_done: done });
                });
                
                const data = {
                    title: w.t,
                    difficulty: document.getElementById('rpe').value,
                    exercises: res
                };
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                tg.sendData(JSON.stringify(data));
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º (–Ω–∞ —Å–ª—É—á–∞–π –ª–∞–≥–∞)
                setTimeout(() => tg.close(), 100);
                
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e); // –ü–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ —Å –¥–∞–Ω–Ω—ã–º–∏
            }
        }
    </script>
</body>
</html>
