<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Fitness</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --card: #1c1c1e; --blue: #007aff; --text: #fff; --gray: #8e8e93; --green: #32d74b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 100px; user-select: none; margin:0; padding:10px; }
        
        /* –£–ü–†–û–©–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –°–ö–û–†–û–°–¢–ò */
        h1 { font-size: 22px; margin: 10px 0; }
        .info-row { display: flex; justify-content: space-between; color: var(--gray); font-size: 14px; margin-bottom: 20px; }
        
        .ex-card { background: var(--card); border-radius: 14px; padding: 12px; margin-bottom: 12px; border: 1px solid #333; }
        .ex-head { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .ex-name { font-weight: bold; font-size: 16px; width: 70%; }
        .ex-rest { font-size: 12px; background: #333; padding: 2px 6px; border-radius: 4px; height: fit-content; }

        .set-row { display: flex; align-items: center; margin-bottom: 8px; background: #000; padding: 5px; border-radius: 8px; }
        .set-n { color: #555; width: 20px; font-size: 12px; }
        input { width: 100%; background: #1c1c1e; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; text-align: center; margin: 0 5px; font-size: 16px; }
        input:disabled { opacity: 0.5; background: #111; }
        
        .check { width: 36px; height: 36px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #444; }
        .check.done { background: var(--green); border-color: var(--green); color: #000; }

        .btn-finish { width: 100%; padding: 15px; background: #ff3b30; color: #fff; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 20px; }

        /* MODAL */
        #rest-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
        .timer-big { font-size: 80px; font-weight: bold; font-variant-numeric: tabular-nums; }
        .btn-skip { background: var(--blue); color: #fff; padding: 12px 30px; border-radius: 10px; border: none; font-size: 16px; }
    </style>
</head>
<body>

    <h1 id="t">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
    <div class="info-row">
        <span id="d">...</span>
        <span id="gt" style="background:#333; padding:2px 6px; border-radius:4px;">00:00</span>
    </div>

    <div id="list"></div>

    <div style="text-align: center; margin-top: 30px;">
        <p style="color:#666; font-size:12px;">–°–ª–æ–∂–Ω–æ—Å—Ç—å (1-10)</p>
        <input type="range" id="rpe" min="1" max="10" value="7" style="accent-color: var(--blue);">
        <button class="btn-finish" onclick="fin()">–ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>

    <!-- REST -->
    <div id="rest-modal">
        <div class="timer-big" id="rt">00:00</div>
        <button class="btn-skip" onclick="stopRest()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp; tg.expand();
        let w = { t: "–û—à–∏–±–∫–∞", d: "", e: [] };
        let start = Date.now();
        let rInt;
        const beep = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

        // 1. –†–ê–°–ü–ê–ö–û–í–ö–ê –î–ê–ù–ù–´–•
        const p = new URLSearchParams(location.search);
        const raw = p.get('data');
        if(raw) {
            try { w = JSON.parse(decodeURIComponent(raw)); } catch(e){ console.log(e); }
        }

        // 2. –û–¢–†–ò–°–û–í–ö–ê (–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –∫–ª—é—á–∏: t, d, e, n, s, r, w, rt)
        document.getElementById('t').innerText = w.t || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
        document.getElementById('d').innerText = "‚è± " + (w.d || "? –º–∏–Ω");

        const list = document.getElementById('list');
        // e = exercises
        (w.e || []).forEach((ex, i) => {
            let setsHtml = '';
            // s = sets (–∫–æ–ª-–≤–æ –ø–æ–¥—Ö–æ–¥–æ–≤)
            const count = ex.s || 3;
            for(let j=0; j<count; j++) {
                // w = weight, r = reps, rt = rest time
                setsHtml += `
                <div class="set-row">
                    <div class="set-n">${j+1}</div>
                    <input type="tel" id="w-${i}-${j}" value="${ex.w || ''}" placeholder="–∫–≥">
                    <input type="tel" id="r-${i}-${j}" value="${ex.r || ''}" placeholder="–ø–æ–≤—Ç">
                    <div class="check" id="btn-${i}-${j}" onclick="toggle(${i},${j},${ex.rt||60})">‚úì</div>
                </div>`;
            }
            // n = name
            list.innerHTML += `
            <div class="ex-card">
                <div class="ex-head">
                    <div class="ex-name">${ex.n}</div>
                    <div class="ex-rest">üïê ${ex.rt||60}—Å</div>
                </div>
                ${setsHtml}
            </div>`;
        });

        // 3. –õ–û–ì–ò–ö–ê
        function toggle(i, j, rest) {
            const b = document.getElementById(`btn-${i}-${j}`);
            const inpW = document.getElementById(`w-${i}-${j}`);
            const inpR = document.getElementById(`r-${i}-${j}`);
            
            if(b.classList.contains('done')) {
                b.classList.remove('done');
                inpW.disabled = false; inpR.disabled = false;
            } else {
                b.classList.add('done');
                inpW.disabled = true; inpR.disabled = true;
                tg.HapticFeedback.notificationOccurred('success');
                runRest(rest);
            }
        }

        function runRest(sec) {
            document.getElementById('rest-modal').style.display = 'flex';
            let t = sec;
            document.getElementById('rt').innerText = fmt(t);
            if(rInt) clearInterval(rInt);
            rInt = setInterval(() => {
                t--;
                document.getElementById('rt').innerText = fmt(t);
                if(t<=0) {
                    clearInterval(rInt);
                    beep.play();
                    tg.HapticFeedback.notificationOccurred('warning');
                    setTimeout(stopRest, 1000);
                }
            }, 1000);
        }

        function stopRest() {
            clearInterval(rInt);
            document.getElementById('rest-modal').style.display = 'none';
        }

        function fmt(s) {
            return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0');
        }

        setInterval(() => {
            document.getElementById('gt').innerText = fmt(Math.floor((Date.now()-start)/1000));
        }, 1000);

        function fin() {
            const res = [];
            (w.e || []).forEach((ex, i) => {
                const count = ex.s || 3;
                let done = 0; let lastW = ex.w;
                for(let j=0; j<count; j++) {
                    if(document.getElementById(`btn-${i}-${j}`).classList.contains('done')) {
                        done++;
                        lastW = document.getElementById(`w-${i}-${j}`).value;
                    }
                }
                if(done > 0) res.push({ name: ex.n, weight: lastW, reps: ex.r, sets_done: done });
            });
            
            const data = {
                title: w.t,
                difficulty: document.getElementById('rpe').value,
                exercises: res
            };
            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>
