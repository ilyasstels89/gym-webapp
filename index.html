<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Fitness</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #000);
            --text-color: var(--tg-theme-text-color, #fff);
            --card-bg: var(--tg-theme-secondary-bg-color, #1c1c1e);
            --accent: var(--tg-theme-button-color, #007aff);
            --gray: #8e8e93;
        }
        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            padding-bottom: 90px;
        }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { margin-top: 0; font-size: 28px; }
        h2 { font-size: 18px; color: var(--gray); margin-bottom: 15px; font-weight: normal;}

        /* –ö–ê–†–¢–û–ß–ö–ò */
        .card {
            background: var(--card-bg);
            padding: 15px; border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø */
        .input-header {
            display: flex; gap: 10px; margin-top: 15px; margin-bottom: 5px;
        }
        .input-label {
            width: 50%; font-size: 12px; color: var(--gray); text-align: center;
        }
        .input-group { display: flex; gap: 10px; }
        input {
            width: 50%; padding: 12px;
            background: #000; border: 1px solid #333;
            color: #fff; border-radius: 8px; text-align: center; font-size: 18px; font-weight: bold;
        }
        input:focus { border-color: var(--accent); outline: none; }

        /* –ö–ù–û–ü–ö–ò */
        .btn {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
            background: var(--accent); color: white; margin-top: 10px;
        }
        .btn-done { background: #32d74b; color: #000; }
        
        /* –°–õ–ê–ô–î–ï–† –°–ê–ú–û–ß–£–í–°–¢–í–ò–Ø */
        .range-container { margin-top: 20px; text-align: center; }
        input[type=range] { width: 100%; accent-color: var(--accent); }

        /* –¢–ê–ô–ú–ï–† –û–¢–î–´–•–ê */
        #rest-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000000; z-index: 200; /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            flex-direction: column; justify-content: center; align-items: center;
        }
        .timer-large { 
            font-size: 90px; font-weight: 800; 
            font-variant-numeric: tabular-nums;
            color: #ffffff; /* –ë–ï–õ–´–ï –¶–ò–§–†–´ */
            margin: 20px 0;
        }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: var(--card-bg); border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center;
            color: #666; font-size: 10px; width: 33%; cursor: pointer;
        }
        .tab-item.active { color: var(--accent); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }
    </style>
</head>
<body>

    <!-- 1. –ì–õ–ê–í–ù–ê–Ø -->
    <div id="tab-home" class="screen active">
        <h1>–ü—Ä–∏–≤–µ—Ç, –ê—Ç–ª–µ—Ç! üöÄ</h1>
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div class="card" id="today-card" style="text-align: center; padding: 30px 20px;">
            <div style="font-size: 40px; margin-bottom: 10px;">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
            <h2 id="workout-title-display" style="color: #fff; font-size: 22px; font-weight: bold; margin-bottom: 5px;">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </h2>
            <p style="color: var(--gray); margin-bottom: 20px;">–ü–ª–∞–Ω –æ—Ç AI –≥–æ—Ç–æ–≤</p>
            <button class="btn" onclick="switchTab('workout')">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>
    </div>

    <!-- 2. –¢–†–ï–ù–ò–†–û–í–ö–ê -->
    <div id="tab-workout" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div style="font-weight: bold; color: var(--gray);" id="workout-title-small">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
            <div id="global-timer" style="font-family:monospace; font-size:18px; background: #333; padding: 4px 8px; border-radius: 6px;">00:00</div>
        </div>
        
        <div id="workout-list"></div>

        <!-- –ë–ª–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
        <div class="card" style="margin-top: 30px;">
            <h3>–ö–∞–∫ –Ω–∞–≥—Ä—É–∑–∫–∞? (1 - –õ–µ–≥–∫–æ, 10 - –û—Ç–∫–∞–∑)</h3>
            <div style="display: flex; justify-content: space-between; color: var(--gray); margin-bottom: 10px;">
                <span>1</span><span>5</span><span>10</span>
            </div>
            <input type="range" id="difficulty-range" min="1" max="10" value="7">
            <button class="btn" style="background:#ff3b30; margin-top: 20px;" onclick="finishWorkout()">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <!-- 3. –ü–†–û–ì–†–ï–°–° -->
    <div id="tab-stats" class="screen">
        <h1>–¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h1>
        <div class="card">
            <p style="color: var(--gray);">–ó–¥–µ—Å—å —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è –≥—Ä–∞—Ñ–∏–∫–∏ —Ç–≤–æ–∏—Ö –ø–æ–±–µ–¥.</p>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –û–¢–î–´–•–ê -->
    <div id="rest-modal">
        <div style="color:#888; font-size: 20px;">–û—Ç–¥—ã—Ö–∞–µ–º...</div>
        <div class="timer-large" id="rest-timer">01:30</div>
        <button class="btn" style="width:200px; background:#333; border: 1px solid #555;" onclick="stopRest()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('home')"><span class="tab-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
        <div class="tab-item" onclick="switchTab('workout')"><span class="tab-icon">üí™</span><span>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span></div>
        <div class="tab-item" onclick="switchTab('stats')"><span class="tab-icon">üìà</span><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let workoutPlan = { title: "–ó–∞–≥—Ä—É–∑–∫–∞...", exercises: [] };
        let completedLog = [];
        let startTime = Date.now();
        let restInt;

        // --- –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• ---
        const urlParams = new URLSearchParams(window.location.search);
        const rawData = urlParams.get('data');

        if (rawData) {
            try {
                // –¢–µ–ø–µ—Ä—å –º—ã –∂–¥–µ–º –æ–±—ä–µ–∫—Ç { title: "...", exercises: [...] }
                let parsed = JSON.parse(decodeURIComponent(rawData));
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                if (Array.isArray(parsed)) {
                    workoutPlan.exercises = parsed;
                    workoutPlan.title = "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ (–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)";
                } else {
                    workoutPlan = parsed;
                }
            } catch(e) { console.error(e); }
        } else {
            // –î–µ–º–æ-—Ä–µ–∂–∏–º
            workoutPlan = {
                title: "üî• –î–µ–º–æ: –ì—Ä—É–¥—å –∏ –¢—Ä–∏—Ü–µ–ø—Å",
                exercises: [
                    {name: "–ñ–∏–º –ª–µ–∂–∞", weight: 60, reps: 10},
                    {name: "–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö", weight: 0, reps: 12}
                ]
            };
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        document.getElementById('workout-title-display').innerText = workoutPlan.title;
        document.getElementById('workout-title-small').innerText = workoutPlan.title;
        renderWorkout();

        // --- –§–£–ù–ö–¶–ò–ò ---
        function switchTab(tab) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –º–µ–Ω—é
            const tabs = ['home', 'workout', 'stats'];
            document.querySelectorAll('.tab-item')[tabs.indexOf(tab)].classList.add('active');
        }

        function renderWorkout() {
            const list = document.getElementById('workout-list');
            list.innerHTML = '';
            
            workoutPlan.exercises.forEach((ex, i) => {
                list.innerHTML += `
                <div class="card">
                    <h3 style="margin:0; margin-bottom: 5px;">${ex.name}</h3>
                    <p style="color:var(--gray); font-size:14px; margin:0;">–ü–ª–∞–Ω: ${ex.weight}–∫–≥ x ${ex.reps}</p>
                    
                    <div class="input-header">
                        <div class="input-label">–í–ï–° (–ö–ì)</div>
                        <div class="input-label">–ü–û–í–¢–û–†–´</div>
                    </div>
                    
                    <div class="input-group">
                        <input type="tel" id="w-${i}" value="${ex.weight}">
                        <input type="tel" id="r-${i}" value="${ex.reps}">
                    </div>
                    
                    <button id="btn-${i}" class="btn" onclick="logSet(${i})">‚úÖ –°–¥–µ–ª–∞–ª</button>
                </div>`;
            });
        }

        function logSet(i) {
            let w = document.getElementById(`w-${i}`).value;
            let r = document.getElementById(`r-${i}`).value;
            
            completedLog.push({
                name: workoutPlan.exercises[i].name,
                weight: w, reps: r
            });
            
            let btn = document.getElementById(`btn-${i}`);
            btn.classList.add('btn-done');
            btn.innerText = '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
            
            startRest(90);
        }

        function startRest(sec) {
            document.getElementById('rest-modal').style.display = 'flex';
            let left = sec;
            updateRestText(left);
            
            restInt = setInterval(() => {
                left--;
                updateRestText(left);
                if(left <= 0) {
                    tg.HapticFeedback.notificationOccurred('success');
                    stopRest();
                }
            }, 1000);
        }

        function updateRestText(s) {
            let m = Math.floor(s/60).toString().padStart(2,'0');
            let sec = (s%60).toString().padStart(2,'0');
            document.getElementById('rest-timer').innerText = `${m}:${sec}`;
        }

        function stopRest() {
            clearInterval(restInt);
            document.getElementById('rest-modal').style.display = 'none';
        }

        setInterval(() => {
            let d = Math.floor((Date.now() - startTime)/1000);
            let m = Math.floor(d/60).toString().padStart(2,'0');
            let s = (d%60).toString().padStart(2,'0');
            document.getElementById('global-timer').innerText = `${m}:${s}`;
        }, 1000);

        function finishWorkout() {
            if (completedLog.length === 0) { tg.close(); return; }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            let difficulty = document.getElementById('difficulty-range').value;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å—ë –±–æ—Ç—É
            const result = {
                title: workoutPlan.title,
                exercises: completedLog,
                difficulty: difficulty // –û—Ü–µ–Ω–∫–∞ –æ—Ç 1 –¥–æ 10
            };
            
            tg.sendData(JSON.stringify(result));
        }
    </script>
</body>
</html>
