<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Fitness</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #000;
            --card-bg: #1c1c1e;
            --accent: #007aff;
            --text: #fff;
            --gray: #8e8e93;
            --green: #32d74b;
        }
        body {
            font-family: -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0; padding: 0;
            padding-bottom: 100px;
            user-select: none;
        }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; padding: 15px; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        h1 { font-size: 24px; margin: 10px 0; }
        h2 { font-size: 16px; color: var(--gray); font-weight: normal; margin-bottom: 20px; }

        /* –ö–ê–†–¢–û–ß–ö–ê –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø */
        .ex-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        .ex-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #333; padding-bottom: 10px;
        }
        .ex-title { font-weight: bold; font-size: 18px; }
        .ex-rest { font-size: 12px; color: var(--gray); background: #333; padding: 4px 8px; border-radius: 6px; }

        /* –°–¢–†–û–ö–ê –ü–û–î–•–û–î–ê */
        .set-row {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
            background: #000; padding: 10px; border-radius: 10px;
        }
        .set-num { color: var(--gray); font-size: 14px; width: 30px; }
        
        .set-inputs { display: flex; gap: 10px; flex-grow: 1; margin: 0 10px; }
        
        input {
            width: 100%; background: #1c1c1e; border: 1px solid #444;
            color: #fff; padding: 8px; border-radius: 6px; text-align: center; font-size: 16px;
            transition: 0.2s;
        }
        
        /* –°–¢–ò–õ–¨ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–û–ì–û –ü–û–õ–Ø (–ö–û–ì–î–ê –ü–û–î–•–û–î –°–î–ï–õ–ê–ù) */
        input:disabled {
            opacity: 0.5;
            background: #111;
            color: #888;
            border-color: #222;
        }
        
        /* –ß–ï–ö–ë–û–ö–° –ü–û–î–•–û–î–ê */
        .check-btn {
            width: 40px; height: 40px;
            background: #333; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.2s; border: 2px solid #444;
            font-size: 18px;
        }
        .check-btn.done { 
            background: var(--green); 
            border-color: var(--green); 
            color: #000; 
        }

        /* –ú–û–î–ê–õ–ö–ê –û–¢–î–´–•–ê */
        #rest-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 200;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .timer-display { font-size: 80px; font-weight: bold; color: #fff; margin: 30px 0; font-variant-numeric: tabular-nums; }
        .btn { width: 200px; padding: 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 16px; background: var(--accent); color: #fff; }

    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –¢–†–ï–ù–ò–†–û–í–ö–ò -->
    <div id="screen-workout" class="screen active">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h1 id="workout-title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                <h2 id="workout-duration">‚è± –û—Ü–µ–Ω–∫–∞: ...</h2>
            </div>
            <div id="global-timer" style="font-family: monospace; font-size: 16px; background: #333; padding: 5px 8px; border-radius: 6px;">00:00</div>
        </div>

        <div id="exercises-list"></div>

        <div style="height: 50px;"></div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <p style="color: #666; font-size: 14px;">–û—Ü–µ–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å (1-10)</p>
            <input type="range" id="rpe-slider" min="1" max="10" value="7" style="width: 80%; accent-color: var(--accent);">
            <br>
            <button class="btn" style="background: #ff3b30; margin-top: 15px; width: 90%;" onclick="finishWorkout()">üèÅ –ó–ê–í–ï–†–®–ò–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù –û–¢–î–´–•–ê -->
    <div id="rest-modal">
        <h2 style="color: #fff;">–û—Ç–¥—ã—Ö</h2>
        <div class="timer-display" id="rest-timer">00:00</div>
        <button class="btn" onclick="stopRest()">–°–≤–µ—Ä–Ω—É—Ç—å —Ç–∞–π–º–µ—Ä</button>
        <p style="color: #666; margin-top: 20px; font-size: 14px;">–ó–≤—É–∫ –≤–∫–ª—é—á–∏—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ üîî</p>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let workout = { title: "–ó–∞–≥—Ä—É–∑–∫–∞", duration: "...", exercises: [] };
        let startTime = Date.now();
        let restInterval;
        const beepSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

        // 1. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–•
        const urlParams = new URLSearchParams(window.location.search);
        const rawData = urlParams.get('data');

        if (rawData) {
            try {
                workout = JSON.parse(decodeURIComponent(rawData));
                if (Array.isArray(workout)) workout = { title: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", duration: "~45 –º–∏–Ω", exercises: workout };
            } catch(e) { console.error(e); }
        } else {
            // –î–ï–ú–û
            workout = {
                title: "–î–µ–º–æ: –°–ø–∏–Ω–∞",
                duration: "45 –º–∏–Ω",
                exercises: [
                    { name: "–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", sets: 3, reps: 10, weight: 0, rest: 90 },
                    { name: "–¢—è–≥–∞ —à—Ç–∞–Ω–≥–∏", sets: 3, reps: 12, weight: 60, rest: 60 }
                ]
            };
        }

        document.getElementById('workout-title').innerText = workout.title;
        document.getElementById('workout-duration').innerText = "‚è± " + (workout.duration || "–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ");
        renderExercises();

        // 2. –û–¢–†–ò–°–û–í–ö–ê
        function renderExercises() {
            const container = document.getElementById('exercises-list');
            container.innerHTML = '';

            workout.exercises.forEach((ex, exIdx) => {
                let rowsHtml = '';
                const setsCount = ex.sets || 3; 
                
                for (let i = 0; i < setsCount; i++) {
                    rowsHtml += `
                    <div class="set-row">
                        <div class="set-num">${i + 1}</div>
                        <div class="set-inputs">
                            <input type="tel" id="w-${exIdx}-${i}" value="${ex.weight}" placeholder="–∫–≥">
                            <input type="tel" id="r-${exIdx}-${i}" value="${ex.reps}" placeholder="–ø–æ–≤—Ç">
                        </div>
                        <div class="check-btn" id="btn-${exIdx}-${i}" onclick="toggleSet(${exIdx}, ${i}, ${ex.rest || 60})">
                            ‚úì
                        </div>
                    </div>`;
                }

                container.innerHTML += `
                <div class="ex-card">
                    <div class="ex-header">
                        <div class="ex-title">${ex.name}</div>
                        <div class="ex-rest">–û—Ç–¥—ã—Ö: ${ex.rest || 60} —Å</div>
                    </div>
                    ${rowsHtml}
                </div>`;
            });
        }

        // 3. –õ–û–ì–ò–ö–ê –ü–û–î–•–û–î–û–í (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï)
        function toggleSet(exIdx, setIdx, restTime) {
            const btn = document.getElementById(`btn-${exIdx}-${setIdx}`);
            const wInput = document.getElementById(`w-${exIdx}-${setIdx}`);
            const rInput = document.getElementById(`r-${exIdx}-${setIdx}`);
            
            if (btn.classList.contains('done')) {
                // –û–¢–ú–ï–ù–ê (–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï)
                // 1. –£–±–∏—Ä–∞–µ–º –≥–∞–ª–æ—á–∫—É
                btn.classList.remove('done');
                // 2. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è
                wInput.disabled = false;
                rInput.disabled = false;
                // –¢–∞–π–º–µ—Ä –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º (–ø—É—Å—Ç—å –∏–¥–µ—Ç —Ñ–æ–Ω–æ–º, –µ—Å–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ –æ—à–∏–±—Å—è —Ü–∏—Ñ—Ä–æ–π)
            } else {
                // –í–´–ü–û–õ–ù–ï–ù–ò–ï
                // 1. –°—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É
                btn.classList.add('done');
                // 2. –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—è (—á—Ç–æ–±—ã —Å–ª—É—á–∞–π–Ω–æ –Ω–µ –Ω–∞–∂–∞—Ç—å)
                wInput.disabled = true;
                rInput.disabled = true;
                
                tg.HapticFeedback.notificationOccurred('success');
                
                // 3. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                startRest(restTime);
            }
        }

        // 4. –¢–ê–ô–ú–ï–†
        function startRest(seconds) {
            document.getElementById('rest-modal').style.display = 'flex';
            let timeLeft = seconds;
            updateRestDisplay(timeLeft);

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª
            if(restInterval) clearInterval(restInterval);

            restInterval = setInterval(() => {
                timeLeft--;
                updateRestDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(restInterval);
                    beepSound.play();
                    tg.HapticFeedback.notificationOccurred('warning');
                    setTimeout(stopRest, 2000); // –ê–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫
                }
            }, 1000);
        }

        function updateRestDisplay(sec) {
            let m = Math.floor(sec / 60).toString().padStart(2, '0');
            let s = (sec % 60).toString().padStart(2, '0');
            document.getElementById('rest-timer').innerText = `${m}:${s}`;
        }

        function stopRest() {
            clearInterval(restInterval);
            document.getElementById('rest-modal').style.display = 'none';
        }

        // 5. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –í–†–ï–ú–Ø
        setInterval(() => {
            let diff = Math.floor((Date.now() - startTime) / 1000);
            let m = Math.floor(diff / 60).toString().padStart(2, '0');
            let s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('global-timer').innerText = `${m}:${s}`;
        }, 1000);

        // 6. –ó–ê–í–ï–†–®–ï–ù–ò–ï
        function finishWorkout() {
            const results = [];
            workout.exercises.forEach((ex, exIdx) => {
                const setsCount = ex.sets || 3;
                let completedSets = 0;
                let lastWeight = ex.weight;
                let lastReps = ex.reps;
                
                for (let i = 0; i < setsCount; i++) {
                    const btn = document.getElementById(`btn-${exIdx}-${i}`);
                    if (btn.classList.contains('done')) {
                        completedSets++;
                        // –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –º–µ–Ω—è–ª–∏—Å—å)
                        lastWeight = document.getElementById(`w-${exIdx}-${i}`).value;
                        lastReps = document.getElementById(`r-${exIdx}-${i}`).value;
                    }
                }

                if (completedSets > 0) {
                    results.push({
                        name: ex.name,
                        weight: lastWeight,
                        reps: lastReps,
                        sets_done: completedSets
                    });
                }
            });

            const finalData = {
                title: workout.title,
                difficulty: document.getElementById('rpe-slider').value,
                duration: document.getElementById('global-timer').innerText,
                exercises: results
            };
            
            tg.sendData(JSON.stringify(finalData));
            setTimeout(() => tg.close(), 300);
        }
    </script>
</body>
</html>
