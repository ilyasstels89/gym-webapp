<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Fitness</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #000; --card: #1c1c1e; --blue: #007aff; --text: #fff; --gray: #8e8e93; --green: #32d74b; --orange: #ff9500; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 100px; user-select: none; margin:0; }
        
        h1 { font-size: 20px; margin: 0 0 5px 0; }
        .info-row { display: flex; justify-content: space-between; align-items: center; color: var(--gray); font-size: 14px; margin-bottom: 20px; }
        
        .ex-card { background: var(--card); border-radius: 14px; padding: 12px; margin-bottom: 15px; border: 1px solid #333; }
        .ex-head { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .ex-name { font-weight: bold; font-size: 16px; width: 75%; }
        .ex-rest { font-size: 11px; background: #333; padding: 2px 6px; border-radius: 4px; height: fit-content; display: flex; align-items: center;}

        .col-headers { display: flex; margin-bottom: 5px; font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px;}
        .col-spacer { width: 25px; } 
        .col-w { flex: 1; text-align: center; }
        .col-r { flex: 1; text-align: center; }
        .col-check { width: 36px; }

        .set-row { display: flex; align-items: center; margin-bottom: 8px; background: #0b0b0b; padding: 6px; border-radius: 8px; }
        .set-n { color: #555; width: 25px; font-size: 12px; text-align: center;}
        
        input { 
            width: 100%; background: #1c1c1e; border: 1px solid #333; 
            color: #fff; padding: 10px; border-radius: 6px; text-align: center; margin: 0 5px; font-size: 16px; font-weight: bold;
        }
        input:focus { border-color: var(--blue); outline: none; }
        input:disabled { opacity: 0.4; background: #111; border-color: #222; }
        
        /* –ö–ù–û–ü–ö–ò */
        .check { width: 36px; height: 36px; background: #222; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #333; font-size: 18px; color: #444; }
        .check.done { background: var(--green); border-color: var(--green); color: #000; }
        
        .play-btn { width: 30px; height: 30px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 5px; cursor: pointer; color: var(--blue); border: 1px solid #444; }

        .btn-finish { width: 100%; padding: 16px; background: #ff3b30; color: #fff; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 20px; }

        /* MODAL */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
        #modal-title { color: #888; font-size: 20px; margin-bottom: 10px;}
        .timer-big { font-size: 90px; font-weight: bold; font-variant-numeric: tabular-nums; margin-bottom: 30px;}
        .btn-skip { background: #333; color: #fff; padding: 15px 40px; border-radius: 30px; border: 1px solid #444; font-size: 16px; }
        .btn-skip.work { border-color: var(--orange); color: var(--orange); } /* –°—Ç–∏–ª—å –¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞ */
    </style>
</head>
<body>

    <h1 id="t">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
    <div class="info-row">
        <span id="d">...</span>
        <span id="gt" style="font-family: monospace; background:#222; padding:4px 8px; border-radius:6px;">00:00</span>
    </div>

    <div id="list"></div>

    <div style="text-align: center; margin-top: 40px;">
        <p style="color:#666; font-size:12px; margin-bottom: 10px;">–°–ª–æ–∂–Ω–æ—Å—Ç—å (1-10)</p>
        <input type="range" id="rpe" min="1" max="10" value="7" style="accent-color: var(--blue); margin-bottom: 20px;">
        <button class="btn-finish" onclick="fin()">üèÅ –ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>

    <!-- –¢–ê–ô–ú–ï–† (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π: –∏ –¥–ª—è –†–∞–±–æ—Ç—ã, –∏ –¥–ª—è –û—Ç–¥—ã—Ö–∞) -->
    <div id="modal">
        <div id="modal-title">–û—Ç–¥—ã—Ö</div>
        <div class="timer-big" id="timer-val">00:00</div>
        <button id="modal-btn" class="btn-skip" onclick="stopTimer()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp; tg.expand();
        let w = { t: "–û—à–∏–±–∫–∞", d: "", e: [] };
        let start = Date.now();
        let timerInt;
        
        // –ó–í–£–ö (–ì—Ä–æ–º–∫–∏–π "–±–∏–ø" 3 —Ä–∞–∑–∞)
        const beepSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        function playAlarm() {
            beepSound.play();
            setTimeout(() => beepSound.play(), 600);
            setTimeout(() => beepSound.play(), 1200);
            tg.HapticFeedback.notificationOccurred('error'); // –î–ª–∏–Ω–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è
        }

        // 1. –†–ê–°–ü–ê–ö–û–í–ö–ê
        const p = new URLSearchParams(location.search);
        const raw = p.get('data');
        if(raw) {
            try { w = JSON.parse(decodeURIComponent(raw)); } catch(e){ console.error(e); }
        }

        document.getElementById('t').innerText = w.t || "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞";
        document.getElementById('d').innerText = "‚è± " + (w.d || "? –º–∏–Ω");
        const list = document.getElementById('list');
        
        // 2. –û–¢–†–ò–°–û–í–ö–ê
        (w.e || []).forEach((ex, i) => {
            let setsHtml = '';
            const count = ex.s || 3;
            // u = unit (reps –∏–ª–∏ sec). –ï—Å–ª–∏ sec, —Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–ø—É—Å–∫–∞
            const isTime = ex.u === 'sec'; 

            for(let j=0; j<count; j++) {
                // –ï—Å–ª–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É PLAY
                let playBtn = isTime 
                    ? `<div class="play-btn" onclick="runWorkTimer(${ex.r})">‚ñ∂</div>` 
                    : '';

                setsHtml += `
                <div class="set-row">
                    <div class="set-n">${j+1}</div>
                    <input type="tel" id="w-${i}-${j}" value="${ex.w || ''}" placeholder="-">
                    
                    ${playBtn} <!-- –ö–Ω–æ–ø–∫–∞ —Ç–∞–π–º–µ—Ä–∞ (–µ—Å–ª–∏ –ø–ª–∞–Ω–∫–∞/–±–µ–≥) -->
                    
                    <input type="tel" id="r-${i}-${j}" value="${ex.r || ''}" placeholder="-">
                    <div class="check" id="btn-${i}-${j}" onclick="toggle(${i},${j},${ex.rt||0})">‚úì</div>
                </div>`;
            }

            list.innerHTML += `
            <div class="ex-card">
                <div class="ex-head">
                    <div class="ex-name">${ex.n}</div>
                    <div class="ex-rest">üïê ${ex.rt > 0 ? ex.rt + '—Å' : '–ù–µ—Ç'}</div>
                </div>
                
                <div class="col-headers">
                    <div class="col-spacer"></div>
                    <div class="col-w">–í–µ—Å (–∫–≥)</div>
                    <div class="col-r">${isTime ? '–í–†–ï–ú–Ø (–°–ï–ö)' : '–ü–û–í–¢–û–†–´'}</div>
                    <div class="col-check"></div>
                </div>

                ${setsHtml}
            </div>`;
        });

        // 3. –õ–û–ì–ò–ö–ê –¢–ê–ô–ú–ï–†–û–í
        function runTimerCommon(seconds, title, isWork) {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-title').innerText = title;
            
            // –ö—Ä–∞—Å–∏–º –∫–Ω–æ–ø–∫—É –µ—Å–ª–∏ —ç—Ç–æ –†–ê–ë–û–¢–ê
            const btn = document.getElementById('modal-btn');
            if(isWork) {
                btn.classList.add('work');
                btn.innerText = "–°—Ç–æ–ø (–Ø –≤—Å—ë)";
            } else {
                btn.classList.remove('work');
                btn.innerText = "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å";
            }

            let t = seconds;
            document.getElementById('timer-val').innerText = fmt(t);
            
            if(timerInt) clearInterval(timerInt);
            
            timerInt = setInterval(() => {
                t--;
                document.getElementById('timer-val').innerText = fmt(t);
                if(t<=0) {
                    clearInterval(timerInt);
                    playAlarm(); // –ó–≤—É–∫ —Ö3
                    setTimeout(stopTimer, 2000);
                }
            }, 1000);
        }

        // –¢–∞–π–º–µ—Ä –¥–ª—è –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø (–ü–ª–∞–Ω–∫–∞, –ë–µ–≥)
        function runWorkTimer(sec) {
            runTimerCommon(sec, "üî• –†–∞–±–æ—Ç–∞–µ–º!", true);
        }

        // –¢–∞–π–º–µ—Ä –¥–ª—è –û–¢–î–´–•–ê
        function toggle(i, j, rest) {
            const b = document.getElementById(`btn-${i}-${j}`);
            const inpW = document.getElementById(`w-${i}-${j}`);
            const inpR = document.getElementById(`r-${i}-${j}`);
            
            if(b.classList.contains('done')) {
                b.classList.remove('done');
                inpW.disabled = false; inpR.disabled = false;
            } else {
                b.classList.add('done');
                inpW.disabled = true; inpR.disabled = true;
                tg.HapticFeedback.notificationOccurred('success');
                
                if(rest > 0) {
                    runTimerCommon(rest, "–û—Ç–¥—ã—Ö", false);
                }
            }
        }

        function stopTimer() {
            clearInterval(timerInt);
            document.getElementById('modal').style.display = 'none';
        }

        function fmt(s) {
            return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0');
        }
        setInterval(() => { document.getElementById('gt').innerText = fmt(Math.floor((Date.now()-start)/1000)); }, 1000);

        // 4. –ó–ê–í–ï–†–®–ï–ù–ò–ï
        function fin() {
            try {
                const res = [];
                (w.e || []).forEach((ex, i) => {
                    const count = ex.s || 3;
                    let done = 0; let lastW = ex.w;
                    for(let j=0; j<count; j++) {
                        if(document.getElementById(`btn-${i}-${j}`).classList.contains('done')) {
                            done++;
                            lastW = document.getElementById(`w-${i}-${j}`).value;
                        }
                    }
                    if(done > 0) res.push({ name: ex.n, weight: lastW, reps: ex.r, sets_done: done });
                });
                
                const data = {
                    title: w.t,
                    difficulty: document.getElementById('rpe').value,
                    exercises: res
                };
                tg.sendData(JSON.stringify(data));
                setTimeout(() => tg.close(), 100);
            } catch (e) { alert("–û—à–∏–±–∫–∞: " + e); }
        }
    </script>
</body>
</html>
